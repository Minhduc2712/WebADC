@model ErpOnlineOrder.Application.DTOs.OrderDTOs.UpdateOrderDto
@{
    ViewData["Title"] = "Sửa đơn hàng";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
    var products = ViewBag.Products as IEnumerable<ErpOnlineOrder.Application.DTOs.ProductDTO> ?? Enumerable.Empty<ErpOnlineOrder.Application.DTOs.ProductDTO>();
    var order = ViewBag.Order as ErpOnlineOrder.Application.DTOs.OrderDTO;
    var customerName = order?.Customer_name ?? "—";
}

<div class="container-fluid">
    <div class="mb-4">
        <h4 class="mb-0">Sửa đơn hàng @Model.Order_code</h4>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="@Url.Action("Index", "Order")">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="@Url.Action("Index")">Đơn hàng</a></li>
                <li class="breadcrumb-item"><a href="@Url.Action("Details", new { id = Model.Id })">@Model.Order_code</a></li>
                <li class="breadcrumb-item active">Sửa</li>
            </ol>
        </nav>
    </div>

    <form asp-action="Edit" asp-route-id="@Model.Id" method="post" id="orderForm">
        <input type="hidden" asp-for="Id" />
        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h6 class="mb-0"><i class="fas fa-box me-2"></i>Sản phẩm</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Chọn sản phẩm để thêm</label>
                            <select id="productSelect" class="form-select">
                                <option value="">-- Chọn sản phẩm --</option>
                                @foreach (var p in products)
                                {
                                    var price = decimal.TryParse(p.Product_price, out var pr) ? pr : 0;
                                    <option value="@p.Id" data-name="@p.Product_name" data-price="@price">
                                        @p.Product_code - @p.Product_name (@p.Product_price VNĐ)
                                    </option>
                                }
                            </select>
                        </div>
                        <button type="button" class="btn btn-outline-primary mb-3" onclick="addProduct()">
                            <i class="fas fa-plus me-2"></i>Thêm sản phẩm
                        </button>

                        <table class="table table-bordered" id="orderItemsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Sản phẩm</th>
                                    <th style="width: 120px;">Số lượng</th>
                                    <th style="width: 150px;">Đơn giá</th>
                                    <th style="width: 150px;">Thành tiền</th>
                                    <th style="width: 60px;"></th>
                                </tr>
                            </thead>
                            <tbody id="orderItems">
                                @{
                                    var idx = 0;
                                }
                                @foreach (var item in Model.Order_details)
                                {
                                    var productName = order?.Order_details?.FirstOrDefault(od => od.Product_id == item.Product_id)?.Product_name ?? "Sản phẩm";
                                    <tr>
                                        <td>
                                            @productName
                                            <input type="hidden" name="Order_details[@idx].Product_id" value="@item.Product_id" />
                                        </td>
                                        <td>
                                            <input type="number" name="Order_details[@idx].Quantity" value="@item.Quantity" min="1"
                                                   class="form-control form-control-sm quantity-input" onchange="updateTotal()" />
                                        </td>
                                        <td>
                                            <input type="number" name="Order_details[@idx].Unit_price" value="@item.Unit_price" step="0.01"
                                                   class="form-control form-control-sm price-input" onchange="updateTotal()" />
                                        </td>
                                        <td class="item-total">@((item.Quantity * item.Unit_price).ToString("N0")) VNĐ</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    idx++;
                                }
                            </tbody>
                            <tfoot>
                                <tr class="table-light">
                                    <td colspan="3" class="text-end"><strong>Tổng cộng:</strong></td>
                                    <td><strong id="totalAmount">0</strong> VNĐ</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Thông tin đơn hàng</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Order_code" class="form-label">Mã đơn hàng <span class="text-danger">*</span></label>
                            <input asp-for="Order_code" class="form-control" />
                            <span asp-validation-for="Order_code" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="Order_date" class="form-label">Ngày đặt hàng</label>
                            <input asp-for="Order_date" class="form-control" type="date" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Khách hàng</label>
                            <input type="text" class="form-control bg-light" value="@customerName" readonly />
                        </div>
                        <div class="mb-3">
                            <label asp-for="Shipping_address" class="form-label">Địa chỉ giao hàng</label>
                            <textarea asp-for="Shipping_address" class="form-control" rows="2" placeholder="Có thể để trống"></textarea>
                        </div>
                        <div class="mb-3">
                            <label asp-for="note" class="form-label">Ghi chú</label>
                            <textarea asp-for="note" class="form-control" rows="2" placeholder="Có thể để trống"></textarea>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>Cập nhật đơn hàng
                    </button>
                    <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Hủy
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        let itemIndex = @Model.Order_details.Count;

        function addProduct() {
            const select = document.getElementById('productSelect');
            const productId = select.value;
            if (!productId) return;

            const option = select.options[select.selectedIndex];
            const name = option.dataset.name;
            const price = parseFloat(option.dataset.price) || 0;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    ${name}
                    <input type="hidden" name="Order_details[${itemIndex}].Product_id" value="${productId}" />
                </td>
                <td>
                    <input type="number" name="Order_details[${itemIndex}].Quantity" value="1" min="1"
                           class="form-control form-control-sm quantity-input" onchange="updateTotal()" />
                </td>
                <td>
                    <input type="number" name="Order_details[${itemIndex}].Unit_price" value="${price}" step="0.01"
                           class="form-control form-control-sm price-input" onchange="updateTotal()" />
                </td>
                <td class="item-total">${price.toLocaleString()} VNĐ</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;
            document.getElementById('orderItems').appendChild(row);
            itemIndex++;
            select.value = '';
            updateTotal();
        }

        function removeRow(btn) {
            btn.closest('tr').remove();
            updateTotal();
        }

        function updateTotal() {
            let total = 0;
            document.querySelectorAll('#orderItems tr').forEach(row => {
                const qty = parseFloat(row.querySelector('.quantity-input')?.value) || 0;
                const price = parseFloat(row.querySelector('.price-input')?.value) || 0;
                const itemTotal = qty * price;
                const totalCell = row.querySelector('.item-total');
                if (totalCell) totalCell.textContent = itemTotal.toLocaleString() + ' VNĐ';
                total += itemTotal;
            });
            document.getElementById('totalAmount').textContent = total.toLocaleString();
        }

        document.addEventListener('DOMContentLoaded', updateTotal);
    </script>
}
