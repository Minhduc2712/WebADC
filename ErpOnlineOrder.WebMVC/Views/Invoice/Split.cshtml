@model ErpOnlineOrder.Application.DTOs.InvoiceDTOs.InvoiceDto
@{
    ViewData["Title"] = "Tách hóa đơn";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid">
    <div class="mb-4">
        <h4 class="mb-0">Tách hóa đơn</h4>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="@Url.Action("Dashboard", "Home")">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="@Url.Action("Index")">Hóa đơn</a></li>
                <li class="breadcrumb-item active">Tách hóa đơn</li>
            </ol>
        </nav>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0">
                        <i class="fas fa-file-invoice me-2"></i>Hóa đơn: <strong>@Model.Invoice_code</strong>
                        <span class="badge bg-info ms-2">@Model.Customer_name</span>
                    </h6>
                </div>
                <div class="card-body">
                    <form asp-action="Split" method="post" id="splitForm">
                        <input type="hidden" name="Source_invoice_id" value="@Model.Id" />
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Chọn các sản phẩm và số lượng để tách thành hóa đơn mới. Các sản phẩm không được chọn sẽ giữ lại trong hóa đơn gốc.
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ghi chú</label>
                            <textarea name="Note" class="form-control" rows="2" placeholder="Lý do tách hóa đơn..."></textarea>
                        </div>

                        <h6 class="mb-3"><i class="fas fa-box me-2"></i>Chọn sản phẩm để tách (Hóa đơn mới #1)</h6>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 50px;">
                                            <input type="checkbox" class="form-check-input" id="selectAll" onclick="toggleAll(this)" />
                                        </th>
                                        <th>Sản phẩm</th>
                                        <th style="width: 100px;">Số lượng gốc</th>
                                        <th style="width: 120px;">SL tách</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < Model.Details.Count; i++)
                                    {
                                        var detail = Model.Details[i];
                                        <tr>
                                            <td>
                                                <input type="checkbox" class="form-check-input item-checkbox" 
                                                       data-index="@i" onchange="toggleItem(this, @i)" />
                                            </td>
                                            <td>
                                                @detail.Product_name
                                                <input type="hidden" id="detail_id_@i" name="Split_parts[0].Items[@i].Invoice_detail_id" 
                                                       value="@detail.Id" disabled />
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-secondary">@detail.Quantity</span>
                                            </td>
                                            <td>
                                                <input type="number" id="qty_@i" name="Split_parts[0].Items[@i].Quantity" 
                                                       class="form-control form-control-sm quantity-input" 
                                                       min="1" max="@detail.Quantity" value="@detail.Quantity" 
                                                       disabled onchange="updateSplitTotal()" />
                                            </td>
                                            <td>@detail.Unit_price.ToString("N0") VNĐ</td>
                                            <td class="item-total" data-price="@detail.Unit_price">
                                                @detail.Total_price.ToString("N0") VNĐ
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr class="table-warning">
                                        <td colspan="5" class="text-end"><strong>Tổng tiền tách:</strong></td>
                                        <td><strong id="splitTotal">0</strong> VNĐ</td>
                                    </tr>
                                    <tr class="table-info">
                                        <td colspan="5" class="text-end"><strong>Còn lại hóa đơn gốc:</strong></td>
                                        <td><strong id="remainTotal">@Model.Total_amount.ToString("N0")</strong> VNĐ</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="d-flex gap-2 mt-3">
                            <button type="submit" class="btn btn-primary" id="splitBtn" disabled>
                                <i class="fas fa-cut me-2"></i>Tách hóa đơn
                            </button>
                            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Hủy
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Thông tin hóa đơn gốc</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td class="text-muted">Mã hóa đơn:</td>
                            <td><strong>@Model.Invoice_code</strong></td>
                        </tr>
                        <tr>
                            <td class="text-muted">Khách hàng:</td>
                            <td>@Model.Customer_name</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Ngày tạo:</td>
                            <td>@Model.Invoice_date.ToString("dd/MM/yyyy")</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Tổng tiền:</td>
                            <td class="text-success fw-bold">@Model.Total_amount.ToString("N0") VNĐ</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Thuế:</td>
                            <td>@Model.Tax_amount.ToString("N0") VNĐ</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Tổng cộng:</td>
                            <td class="text-primary fw-bold">@Model.Grand_total.ToString("N0") VNĐ</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Hướng dẫn</h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-0">
                        <ul class="mb-0 small">
                            <li>Chọn các sản phẩm muốn tách sang hóa đơn mới</li>
                            <li>Có thể tách một phần số lượng của sản phẩm</li>
                            <li>Hóa đơn gốc sẽ được cập nhật sau khi tách</li>
                            <li>Có thể hoàn tác việc tách nếu cần</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const originalTotal = @Model.Total_amount;
    
    function toggleAll(checkbox) {
        document.querySelectorAll('.item-checkbox').forEach((cb, index) => {
            cb.checked = checkbox.checked;
            toggleItem(cb, index);
        });
    }

    function toggleItem(checkbox, index) {
        const qtyInput = document.getElementById('qty_' + index);
        const detailInput = document.getElementById('detail_id_' + index);
        
        if (checkbox.checked) {
            qtyInput.disabled = false;
            detailInput.disabled = false;
        } else {
            qtyInput.disabled = true;
            detailInput.disabled = true;
        }
        
        updateSplitTotal();
    }

    function updateSplitTotal() {
        let splitTotal = 0;
        let hasSelection = false;
        
        document.querySelectorAll('.item-checkbox').forEach((cb, index) => {
            if (cb.checked) {
                hasSelection = true;
                const qty = parseFloat(document.getElementById('qty_' + index).value) || 0;
                const price = parseFloat(cb.closest('tr').querySelector('.item-total').dataset.price) || 0;
                splitTotal += qty * price;
            }
        });
        
        document.getElementById('splitTotal').textContent = splitTotal.toLocaleString();
        document.getElementById('remainTotal').textContent = (originalTotal - splitTotal).toLocaleString();
        document.getElementById('splitBtn').disabled = !hasSelection || splitTotal <= 0;
    }
</script>
}
