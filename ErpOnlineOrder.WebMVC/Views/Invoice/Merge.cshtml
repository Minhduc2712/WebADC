@model IEnumerable<ErpOnlineOrder.Application.DTOs.InvoiceDTOs.InvoiceDto>
@{
    ViewData["Title"] = "Gộp hóa đơn";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid">
    <div class="mb-4">
        <h4 class="mb-0">Gộp hóa đơn</h4>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="@Url.Action("Index", "Order")">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="@Url.Action("Index")">Hóa đơn</a></li>
                <li class="breadcrumb-item active">Gộp hóa đơn</li>
            </ol>
        </nav>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0"><i class="fas fa-compress-arrows-alt me-2"></i>Chọn hóa đơn để gộp</h6>
                </div>
                <div class="card-body">
                    <form asp-action="Merge" method="post" id="mergeForm">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Chọn ít nhất 2 hóa đơn <strong>cùng khách hàng</strong> để gộp. Các hóa đơn phải ở trạng thái "Chờ xử lý" hoặc "Đã xác nhận".
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ghi chú</label>
                            <textarea name="Note" class="form-control" rows="2" placeholder="Lý do gộp hóa đơn..."></textarea>
                        </div>

                        <input type="hidden" name="Customer_id" id="customerId" value="0" />

                        @if (!Model.Any())
                        {
                            <div class="text-center py-5 text-muted">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>Không có hóa đơn nào có thể gộp</p>
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 50px;">
                                                <input type="checkbox" class="form-check-input" id="selectAll" onclick="toggleAll(this)" />
                                            </th>
                                            <th>Mã hóa đơn</th>
                                            <th>Khách hàng</th>
                                            <th>Ngày tạo</th>
                                            <th>Tổng tiền</th>
                                            <th>Số SP</th>
                                            <th>Trạng thái</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var invoice in Model)
                                        {
                                            var statusClass = invoice.Status switch
                                            {
                                                "Pending" => "bg-warning text-dark",
                                                "Confirmed" => "bg-primary",
                                                "Processing" => "bg-info",
                                                _ => "bg-secondary"
                                            };
                                            var statusText = invoice.Status switch
                                            {
                                                "Pending" => "Chờ xử lý",
                                                "Confirmed" => "Đã xác nhận",
                                                "Processing" => "Đang xử lý",
                                                _ => invoice.Status
                                            };
                                            <tr>
                                                <td>
                                                    <input type="checkbox" class="form-check-input invoice-checkbox" 
                                                           name="Invoice_ids" value="@invoice.Id" 
                                                           data-customer="@invoice.Customer_id" 
                                                           data-amount="@invoice.Total_amount"
                                                           onchange="updateSelection()" />
                                                </td>
                                                <td><span class="badge bg-secondary">@invoice.Invoice_code</span></td>
                                                <td>@invoice.Customer_name</td>
                                                <td>@invoice.Invoice_date.ToString("dd/MM/yyyy")</td>
                                                <td class="text-success fw-bold">@invoice.Total_amount.ToString("N0") VNĐ</td>
                                                <td><span class="badge bg-info">@invoice.Details.Count</span></td>
                                                <td><span class="badge @statusClass">@statusText</span></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <div class="d-flex gap-2 mt-3">
                                <button type="submit" class="btn btn-primary" id="mergeBtn" disabled>
                                    <i class="fas fa-compress-arrows-alt me-2"></i>Gộp hóa đơn đã chọn
                                </button>
                                <a asp-action="Index" class="btn btn-secondary">
                                    <i class="fas fa-times me-2"></i>Hủy
                                </a>
                            </div>
                        }
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Tổng kết</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td class="text-muted">Số hóa đơn đã chọn:</td>
                            <td><strong id="selectedCount">0</strong></td>
                        </tr>
                        <tr>
                            <td class="text-muted">Tổng tiền:</td>
                            <td class="text-success fw-bold"><span id="totalAmount">0</span> VNĐ</td>
                        </tr>
                    </table>
                    
                    <div id="customerWarning" class="alert alert-danger d-none">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Các hóa đơn phải cùng một khách hàng!
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Hướng dẫn</h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-0">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Lưu ý quan trọng:</h6>
                        <ul class="mb-0 small">
                            <li>Chỉ gộp được các hóa đơn <strong>cùng khách hàng</strong></li>
                            <li>Hóa đơn đã hoàn thành hoặc đã hủy không thể gộp</li>
                            <li>Sau khi gộp, các hóa đơn gốc sẽ bị hủy</li>
                            <li>Có thể hoàn tác gộp nếu cần</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function toggleAll(checkbox) {
        document.querySelectorAll('.invoice-checkbox').forEach(cb => {
            cb.checked = checkbox.checked;
        });
        updateSelection();
    }

    function updateSelection() {
        const checked = document.querySelectorAll('.invoice-checkbox:checked');
        const count = checked.length;
        let total = 0;
        const customers = new Set();
        let customerId = 0;
        
        checked.forEach(cb => {
            customers.add(cb.dataset.customer);
            total += parseFloat(cb.dataset.amount) || 0;
            customerId = cb.dataset.customer;
        });
        
        document.getElementById('selectedCount').textContent = count;
        document.getElementById('totalAmount').textContent = total.toLocaleString();
        document.getElementById('customerId').value = customerId;
        
        const customerWarning = document.getElementById('customerWarning');
        const mergeBtn = document.getElementById('mergeBtn');
        
        if (customers.size > 1) {
            customerWarning.classList.remove('d-none');
            mergeBtn.disabled = true;
        } else {
            customerWarning.classList.add('d-none');
            mergeBtn.disabled = count < 2;
        }
    }
</script>
}
